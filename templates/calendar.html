{% extends "base.html" %}
{% block title %}Attendance Calendar{% endblock %}
{% block content %}
<h2>ðŸ“… Attendance Calendar</h2>
<div id="calendar"></div>

<!-- Popup -->
<div id="form-popup" class="popup">
<h3>Mark Attendance</h3>
<label>User:</label><select id="userName"></select>
<label>Status:</label>
<select id="status">
<option>Present</option>
<option>Absent</option>
<option>Half Day</option>
<option>Overtime</option>
</select>
<label>Shift:</label>
<select id="shift">
<option>Morning</option><option>Evening</option><option>Night</option><option>Regular</option><option>All Clear</option>
</select>
<label>More Options:</label>
<select id="moreOptions"><option>Holiday</option><option>Weekly Off</option></select>
<label>Leave:</label>
<select id="leave"><option>PL</option><option>CL</option><option>SL</option><option>Other</option></select>
<label>Notes:</label><textarea id="note"></textarea>
<button onclick="submitAttendance()">Submit</button>
<button class="cancel" onclick="closeForm()">Cancel</button>
</div>
{% endblock %}
{% block scripts %}
<script>
// Load users
function loadUsers() {
fetch("/users-list").then(r=>r.json()).then(users=>{
let dropdown = document.getElementById("userName");
dropdown.innerHTML = '<option value="">Select User</option>';
users.forEach(u=>dropdown.innerHTML += `<option value="${u.name}">${u.name}</option>`);
});
}
// Show/Hide popup
function showPopup(){document.getElementById("form-popup").style.display="block";}
function closeForm(){document.getElementById("form-popup").style.display="none";}

// Submit attendance
function submitAttendance(){
const data={
name:document.getElementById("userName").value,
status:document.getElementById("status").value,
shift:document.getElementById("shift").value,
moreOptions:document.getElementById("moreOptions").value,
leave:document.getElementById("leave").value,
note:document.getElementById("note").value,
date:new Date().toISOString().split("T")[0]
};
if(!data.name){alert("Select User");return;}
fetch("/mark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)})
.then(r=>r.json()).then(d=>{alert(d.message); closeForm(); location.reload();});
}

// Calendar
document.addEventListener("DOMContentLoaded", function(){
loadUsers();
var calendarEl = document.getElementById('calendar');
var calendar = new FullCalendar.Calendar(calendarEl,{
initialView:'dayGridMonth',
headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek'},
events:'/events',
eventClick:function(info){alert(info.event.title);}
});
calendar.render();
});
</script>
{% endblock %}
