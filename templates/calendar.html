{% extends "base.html" %}
{% block title %}Attendance Calendar{% endblock %}

{% block content %}
<h3 class="text-center">ðŸ“… Attendance Calendar</h3>
<div id="calendar"></div>

<!-- Attendance Modal -->
<div class="modal fade" id="attendancePopup">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5>Mark Attendance</h5>

      <select id="popupUser" class="form-select mb-2"></select>

      <select id="popupStatus" class="form-select mb-2">
        <option>Present</option>
        <option>Absent</option>
        <option>Half Day</option>
        <option>Overtime</option>
      </select>

      <select id="popupShift" class="form-select mb-2">
        <option>Regular</option>
        <option>Morning</option>
        <option>Evening</option>
        <option>Night</option>
      </select>

      <select id="popupMore" class="form-select mb-2">
        <option value="">None</option>
        <option>Holiday</option>
        <option>Weekly Off</option>
      </select>

      <select id="popupLeave" class="form-select mb-2">
        <option value="">None</option>
        <option>PL</option>
        <option>CL</option>
        <option>SL</option>
        <option>Other</option>
      </select>

      <textarea id="popupNotes" class="form-control mb-2" placeholder="Notes"></textarea>

      <button class="btn btn-primary w-100" onclick="saveAttendance()">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
let selectedDate;
let calendar;

// Load users from localStorage
function loadUsers() {
  const users = JSON.parse(localStorage.getItem("users")) || [];
  popupUser.innerHTML = `<option value="">Select User</option>`;
  users.forEach(u => popupUser.innerHTML += `<option>${u.name}</option>`);
}

// Save attendance locally
function saveAttendance() {
  if (!popupUser.value) {
    alert("Select user");
    return;
  }

  let records = JSON.parse(localStorage.getItem("attendance")) || [];
  records.push({
    date: selectedDate,
    name: popupUser.value,
    status: popupStatus.value,
    shift: popupShift.value,
    more: popupMore.value,
    leave: popupLeave.value,
    notes: popupNotes.value
  });

  localStorage.setItem("attendance", JSON.stringify(records));
  alert("Attendance saved successfully!");
  calendar.refetchEvents();
  bootstrap.Modal.getInstance(attendancePopup).hide();
}

// Load events into calendar
function getEvents(info, successCallback) {
  const records = JSON.parse(localStorage.getItem("attendance")) || [];
  successCallback(records.map(r => ({
    title: `${r.name} - ${r.status}`,
    start: r.date
  })));
}

document.addEventListener("DOMContentLoaded", function () {
  loadUsers();

  calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "dayGridMonth",
    dateClick(info) {
      selectedDate = info.dateStr;
      new bootstrap.Modal(attendancePopup).show();
    },
    events: getEvents
  });

  calendar.render();
});
</script>
{% endblock %}
