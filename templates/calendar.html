{% extends "base.html" %}

{% block title %}Attendance Calendar{% endblock %}
{% block header %}ðŸ“… Attendance Calendar{% endblock %}

{% block content %}
<div id="calendar"></div>

<!-- Attendance Form Popup -->
<div id="form-popup" class="popup" style="display:none; padding:10px; background:white; border:1px solid #ccc; max-width:300px;">
  <h5>Mark Attendance</h5>
  <select id="userName" class="form-control">
    <option value="">Select User</option>
  </select>

  <label>Status:</label>
  <select id="status" class="form-control">
    <option value="Present">Present</option>
    <option value="Absent">Absent</option>
    <option value="Half Day">Half Day</option>
    <option value="PL">PL</option>
    <option value="SL">SL</option>
    <option value="Comp-Off">Comp-Off</option>
  </select>

  <label>Note:</label>
  <textarea id="note" class="form-control"></textarea>

  <label>Comp-Off Comment:</label>
  <input type="text" id="comp_off" class="form-control">

  <button class="btn btn-success mt-2" onclick="submitAttendance()">Submit</button>
  <button class="btn btn-secondary mt-2" onclick="closeForm()">Cancel</button>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
function loadUsers() {
  fetch("/users-list")
    .then(res => res.json())
    .then(users => {
      const dropdown = document.getElementById("userName");
      dropdown.innerHTML = '<option value="">Select User</option>';
      users.forEach(u => {
        dropdown.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      });
    });
}

document.addEventListener("DOMContentLoaded", loadUsers);

function submitAttendance() {
  const record = {
    name: document.getElementById("userName").value,
    status: document.getElementById("status").value,
    note: document.getElementById("note").value,
    comp_off: document.getElementById("comp_off").value,
    date: new Date().toISOString().split('T')[0]
  };

  fetch("/mark", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(record)
  })
  .then(res => res.json())
  .then(d => {
    alert(d.message);
    location.reload();
  });
}

function closeForm() {
  document.getElementById("form-popup").style.display = "none";
}
</script>
{% endblock %}
