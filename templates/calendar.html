{% extends "base.html" %}
{% block title %}Calendar{% endblock %}
{% block content %}

<h4 class="text-center">ðŸ“… Attendance Calendar</h4>
<div id="calendar"></div>

<!-- Modal -->
<div class="modal fade" id="attendanceModal">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5>Mark Attendance</h5>

      <select id="user" class="form-select mb-2"></select>
      <select id="status" class="form-select mb-2">
        <option>Present</option>
        <option>Absent</option>
        <option>Half Day</option>
        <option>Overtime</option>
      </select>

      <select id="shift" class="form-select mb-2">
        <option>Regular</option>
        <option>Morning</option>
        <option>Evening</option>
        <option>Night</option>
      </select>

      <textarea id="note" class="form-control mb-2" placeholder="Notes"></textarea>

      <button class="btn btn-primary w-100" onclick="saveAttendance()">Save</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
let selectedDate = "";
let calendar;

function loadUsers() {
  let users = JSON.parse(localStorage.getItem("users") || "[]");
  user.innerHTML = "<option value=''>Select User</option>";
  users.forEach(u => user.innerHTML += `<option>${u.name}</option>`);
}

function saveAttendance() {
  if (!user.value) return alert("Select user");

  let data = JSON.parse(localStorage.getItem("attendance") || "[]");
  data.push({
    date: selectedDate,
    name: user.value,
    status: status.value,
    shift: shift.value,
    note: note.value
  });
  localStorage.setItem("attendance", JSON.stringify(data));

  calendar.refetchEvents();
  bootstrap.Modal.getInstance(attendanceModal).hide();
}

document.addEventListener("DOMContentLoaded", () => {
  loadUsers();

  calendar = new FullCalendar.Calendar(calendar, {
    initialView: "dayGridMonth",
    dateClick(info) {
      selectedDate = info.dateStr;
      loadUsers();
      new bootstrap.Modal(attendanceModal).show();
    },
    events(fetchInfo, success) {
      let data = JSON.parse(localStorage.getItem("attendance") || "[]");
      success(data.map(d => ({
        title: d.name + " - " + d.status,
        start: d.date
      })));
    }
  });

  calendar.render();
});
</script>
{% endblock %}
