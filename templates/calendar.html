{% extends "base.html" %}
{% block title %}Attendance Calendar{% endblock %}

{% block content %}
<center><h2 class="mb-3">ðŸ“… Attendance Calendar</h2></center>

<div id="calendar"></div>

<!-- ================= Attendance Popup ================= -->
<div id="attendancePopup" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mark Attendance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="mb-2">
          <label>User</label>
          <select id="popupUser" class="form-select">
            <option value="">Select User</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Status</label>
          <select id="popupStatus" class="form-select">
            <option>Present</option>
            <option>Absent</option>
            <option>Half Day</option>
            <option>Overtime</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Shift</label>
          <select id="popupShift" class="form-select">
            <option>Regular</option>
            <option>Morning</option>
            <option>Evening</option>
            <option>Night</option>
          </select>
        </div>

        <div class="mb-2">
          <label>More Options</label>
          <select id="popupMore" class="form-select">
            <option value="">None</option>
            <option>Holiday</option>
            <option>Weekly Off</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Leave</label>
          <select id="popupLeave" class="form-select">
            <option value="">None</option>
            <option>Privileged Leave (PL)</option>
            <option>Casual Leave (CL)</option>
            <option>Sick Leave (SL)</option>
            <option>Other Leave</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Notes</label>
          <textarea id="popupNotes" class="form-control" rows="2"></textarea>
        </div>

        <div class="mt-2">
          <strong>Selected Details</strong>
          <ul id="selectedDetails" class="list-group list-group-flush small"></ul>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="submitAttendance()">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= SUCCESS TOAST ================= -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="successToast" class="toast text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body" id="successToastMsg">
        Attendance saved successfully
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let calendar;
let selectedDate = null;

/* ================= Load Users ================= */
function loadUsers() {
  fetch("/users-list")
    .then(res => res.json())
    .then(users => {
      const select = document.getElementById("popupUser");
      select.innerHTML = '<option value="">Select User</option>';
      users.forEach(u => {
        select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      });
    });
}

/* ================= Selected Details ================= */
function updateSelectedDetails() {
  const list = document.getElementById("selectedDetails");
  list.innerHTML = "";

  const map = {
    "User": popupUser.value,
    "Status": popupStatus.value,
    "Shift": popupShift.value,
    "More": popupMore.value,
    "Leave": popupLeave.value,
    "Notes": popupNotes.value
  };

  Object.entries(map).forEach(([k,v])=>{
    if(v) list.innerHTML += `<li class="list-group-item">${k}: ${v}</li>`;
  });
}

["popupUser","popupStatus","popupShift","popupMore","popupLeave","popupNotes"]
.forEach(id=>{
  document.getElementById(id).addEventListener("change", updateSelectedDetails);
  document.getElementById(id).addEventListener("input", updateSelectedDetails);
});

/* ================= Submit Attendance ================= */
function submitAttendance() {

  if(!popupUser.value){
    alert("Please select user");
    return;
  }

  const data = {
    name: popupUser.value,
    status: popupStatus.value,
    shift: popupShift.value,
    moreOptions: popupMore.value,
    leave: popupLeave.value,
    note: popupNotes.value,
    date: selectedDate
  };

  fetch("/mark", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(d => {

    // Success toast
    successToastMsg.innerText = d.message || "Attendance saved successfully";
    new bootstrap.Toast(successToast).show();

    // Refresh calendar
    calendar.refetchEvents();

    // Close modal
    bootstrap.Modal.getInstance(attendancePopup).hide();

    // Reset form
    popupUser.value="";
    popupNotes.value="";
    updateSelectedDetails();
  });
}

/* ================= Calendar ================= */
document.addEventListener("DOMContentLoaded", function() {

  loadUsers();

  calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "dayGridMonth",
    height: "auto",
    dateClick: function(info){
      selectedDate = info.dateStr;
      new bootstrap.Modal(attendancePopup).show();
      updateSelectedDetails();
    },
    events: "/events"
  });

  calendar.render();
});
</script>
{% endblock %}
