{% extends "base.html" %}
{% block title %}Attendance Calendar{% endblock %}

{% block content %}
<h2>ðŸ“… Attendance Calendar</h2>

<div id="calendar"></div>

<!-- Attendance Form Popup -->
<div id="attendancePopup" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Mark Attendance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
          <label>User:</label>
          <select id="popupUser" class="form-select">
            <option value="">Select User</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Status:</label>
          <select id="popupStatus" class="form-select">
            <option>Present</option>
            <option>Absent</option>
            <option>Half Day</option>
            <option>Overtime</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Shift:</label>
          <select id="popupShift" class="form-select">
            <option>Regular</option>
            <option>Morning</option>
            <option>Evening</option>
            <option>Night</option>
          </select>
        </div>

        <div class="mb-2">
          <label>More Options:</label>
          <select id="popupMore" class="form-select">
            <option value="">None</option>
            <option>Holiday</option>
            <option>Weekly Off</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Leave:</label>
          <select id="popupLeave" class="form-select">
            <option value="">None</option>
            <option>Privileged Leave (PL)</option>
            <option>Casual Leave (CL)</option>
            <option>Sick Leave (SL)</option>
            <option>Other Leave</option>
          </select>
        </div>

        <div class="mb-2">
          <label>Notes:</label>
          <textarea id="popupNotes" class="form-control" placeholder="Optional"></textarea>
        </div>

        <div class="mb-2">
          <strong>Selected Details:</strong>
          <ul id="selectedDetails" class="list-group list-group-flush small"></ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="submitAttendance()">Submit</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Fetch users for dropdown
function loadUsers() {
  fetch("/users-list")
    .then(res => res.json())
    .then(users => {
      const select = document.getElementById("popupUser");
      select.innerHTML = `<option value="">Select User</option>`;
      users.forEach(u => select.innerHTML += `<option value="${u.name}">${u.name}</option>`);
    });
}

// Show selected details
function updateSelectedDetails() {
  const details = document.getElementById("selectedDetails");
  const user = document.getElementById("popupUser").value;
  const status = document.getElementById("popupStatus").value;
  const shift = document.getElementById("popupShift").value;
  const more = document.getElementById("popupMore").value;
  const leave = document.getElementById("popupLeave").value;
  const notes = document.getElementById("popupNotes").value;

  details.innerHTML = '';
  if(user) details.innerHTML += `<li>User: ${user}</li>`;
  if(status) details.innerHTML += `<li>Status: ${status}</li>`;
  if(shift) details.innerHTML += `<li>Shift: ${shift}</li>`;
  if(more) details.innerHTML += `<li>More: ${more}</li>`;
  if(leave) details.innerHTML += `<li>Leave: ${leave}</li>`;
  if(notes) details.innerHTML += `<li>Notes: ${notes}</li>`;
}

// Attach event listeners
["popupUser","popupStatus","popupShift","popupMore","popupLeave","popupNotes"].forEach(id=>{
  document.getElementById(id).addEventListener("change", updateSelectedDetails);
  document.getElementById(id).addEventListener("input", updateSelectedDetails);
});

// Submit attendance
function submitAttendance() {
  const data = {
    name: document.getElementById("popupUser").value,
    status: document.getElementById("popupStatus").value,
    shift: document.getElementById("popupShift").value,
    moreOptions: document.getElementById("popupMore").value,
    leave: document.getElementById("popupLeave").value,
    note: document.getElementById("popupNotes").value,
    date: selectedDate
  };

  if(!data.name){
    alert("Please select a user!");
    return;
  }

  fetch("/mark", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(d => {
    alert(d.message);
    calendar.refetchEvents();
    bootstrap.Modal.getInstance(document.getElementById("attendancePopup")).hide();
  });
}

// FullCalendar setup
let calendar;
let selectedDate = null;
document.addEventListener("DOMContentLoaded", function() {
  loadUsers();

  const calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    selectable: true,
    dateClick: function(info){
      selectedDate = info.dateStr;
      const modal = new bootstrap.Modal(document.getElementById("attendancePopup"));
      modal.show();
      updateSelectedDetails();
    },
    events: '/events'
  });

  calendar.render();
});
</script>
{% endblock %}
