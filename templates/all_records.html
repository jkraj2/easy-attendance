{% extends "base.html" %}

{% block title %}All Records - Attendance App{% endblock %}

{% block content %}
<div class="page-header">
    <h1>All Attendance Records</h1>
    <p>Complete history of all attendance entries (<span id="totalRecords">{{ records|length }}</span> records)</p>
</div>

<div id="message" class="message hidden"></div>

<div class="card">
    <div class="table-controls">
        <input type="text" id="searchInput" placeholder="Search by name..." class="search-input">
        <select id="filterStatus" class="filter-select">
            <option value="">All Status</option>
            <option value="present">Present</option>
            <option value="absent">Absent</option>
            <option value="late">Late</option>
        </select>
    </div>

    <div class="table-responsive">
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="recordsBody">
                {% if records %}
                    {% for record in records|reverse %}
                    <tr data-status="{{ record.status }}" data-timestamp="{{ record.timestamp }}">
                        <td>{{ record.name }}</td>
                        <td>
                            <span class="status-badge status-{{ record.status }}">
                                {{ record.status|capitalize }}
                            </span>
                        </td>
                        <td>{{ record.date }}</td>
                        <td>{{ record.time }}</td>
                        <td>
                            <button class="btn btn-small btn-danger" onclick="deleteRecord('{{ record.timestamp }}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr id="noRecordsRow">
                        <td colspan="5" class="text-center">No records found. Mark your first attendance!</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const filterStatus = document.getElementById('filterStatus');
    const table = document.getElementById('recordsTable');

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', filterTable);
    }

    // Filter functionality
    if (filterStatus) {
        filterStatus.addEventListener('change', filterTable);
    }

    function filterTable() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const statusFilter = filterStatus ? filterStatus.value.toLowerCase() : '';
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        let visibleCount = 0;

        for (let row of rows) {
            // Skip the "no records" row
            if (row.id === 'noRecordsRow') continue;
            
            const nameCell = row.cells[0];
            if (!nameCell) continue;
            
            const name = nameCell.textContent.toLowerCase();
            const status = row.getAttribute('data-status') ? row.getAttribute('data-status').toLowerCase() : '';

            const matchesSearch = name.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
});

// Delete Record Function
async function deleteRecord(timestamp) {
    if (!confirm('Are you sure you want to delete this record?')) {
        return;
    }

    try {
        const response = await fetch('/delete_record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ timestamp })
        });

        const data = await response.json();

        if (data.success) {
            showMessage('Record deleted successfully!', 'success');
            
            // Remove row from table
            const row = document.querySelector(`tr[data-timestamp="${timestamp}"]`);
            if (row) {
                row.remove();
            }
            
            // Update total count
            const totalRecords = document.getElementById('totalRecords');
            const newCount = parseInt(totalRecords.textContent) - 1;
            totalRecords.textContent = newCount;
            
            // Show "no records" message if empty
            const tbody = document.getElementById('recordsBody');
            if (newCount === 0) {
                tbody.innerHTML = '<tr id="noRecordsRow"><td colspan="5" class="text-center">No records found. Mark your first attendance!</td></tr>';
            }
            
        } else {
            showMessage(data.message || 'Error deleting record', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('Error deleting record. Please try again.', 'error');
    }
}

// Show Message Function
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    messageDiv.classList.remove('hidden');
    
    setTimeout(() => {
        messageDiv.classList.add('hidden');
    }, 3000);
}
</script>
{% endblock %}
